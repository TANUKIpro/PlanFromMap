<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🗺️ Semantic Map Platform for HSR</title>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

    <!-- CSS Modules -->
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/layout.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/map-viewer.css">
    <link rel="stylesheet" href="styles/drawing-tools.css">
    <link rel="stylesheet" href="styles/layers-panel.css">
    <link rel="stylesheet" href="styles/metadata-overlay.css">
    <link rel="stylesheet" href="styles/tabs.css">
</head>
<body>
    <div class="container">
        <!-- 隠しファイル入力 -->
        <input type="file" id="imageFileInput" accept="image/*,.pgm" style="display: none;" onchange="handleImageFileSelect(event)">
        <input type="file" id="yamlFileInput" accept=".yaml,.yml" style="display: none;" onchange="handleYAMLFileSelect(event)">

        <!-- タブコンテナ -->
        <div class="tabs-container">
            <!-- タブナビゲーション -->
            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchTab('mapViewer', event)">🗺️ マップビューア</button>
                <button class="tab-button" onclick="switchTab('stats', event)">📊 システム統計</button>
                <button class="tab-button" onclick="switchTab('operations', event)">🚪 操作カタログ</button>
                <button class="tab-button" onclick="switchTab('mapql', event)">🔍 MapQLクエリ</button>
            </div>

            <!-- タブコンテンツ -->
            <div id="mapViewer" class="tab-content active">
                <div class="map-viewer-tab">
                    <div class="map-canvas-container" id="mapContainer">
                        <div class="map-placeholder" id="mapPlaceholder">
                            <div style="text-align: center;">
                                <p style="margin-bottom: 20px; color: #999;">マップがインポートされていません。</p>
                                <button class="load-button" onclick="loadImageFile()">🖼️ 画像を読み込む</button>
                                <button class="load-button" onclick="loadYAMLFile()" style="margin-left: 10px;">📄 YAMLを読み込む</button>
                            </div>
                        </div>
                        <div id="canvasStack" class="canvas-stack" style="display: none;"></div>
                        <canvas id="mapCanvas" style="display: none;"></canvas>

                        <!-- 描画ツールパレット -->
                        <div class="drawing-tools-palette" id="drawingToolsPalette">
                            <button class="tool-button active" id="panTool" onclick="selectTool('pan')" title="パン（移動）">
                                ✋
                            </button>
                            <button class="tool-button" id="pencilTool" onclick="selectTool('pencil')" title="鉛筆">
                                ✏️
                            </button>
                            <button class="tool-button" id="eraserTool" onclick="selectTool('eraser')" title="消しゴム">
                                🧹
                            </button>
                            <button class="tool-button" id="measureTool" onclick="selectTool('measure')" title="測量">
                                📏
                            </button>
                            <button class="tool-button" id="bucketTool" onclick="selectTool('bucket')" title="塗りつぶし">
                                🪣
                            </button>
                            <div class="tool-divider"></div>
                            <div class="color-picker-wrapper">
                                <div class="color-picker-label">色</div>
                                <input type="color" class="color-picker-input" id="colorPicker" value="#FF0000" onchange="changeDrawingColor(this.value)">
                            </div>
                            <div class="brush-size-control">
                                <div class="brush-size-label">サイズ: <span id="brushSizeValue">5</span></div>
                                <input type="range" class="brush-size-slider" id="brushSizeSlider" min="1" max="50" value="5" oninput="changeBrushSize(this.value)">
                            </div>
                        </div>

                        <!-- レイヤーパネル -->
                        <div class="layers-panel" id="layersPanel">
                            <div class="layers-panel-header">
                                <span class="layers-panel-title">レイヤー</span>
                                <button class="layer-add-button" onclick="addNewLayer()">+ 追加</button>
                            </div>
                            <div class="layers-panel-body" id="layersPanelBody">
                                <!-- レイヤーアイテムがここに動的に追加される -->
                            </div>
                        </div>

                        <div class="metadata-overlay-panel" id="metadataOverlay" aria-hidden="true">
                            <div class="metadata-overlay-header">
                                <span class="metadata-overlay-title">📋 マップメタデータ</span>
                                <button
                                    type="button"
                                    class="metadata-overlay-minimize"
                                    onclick="toggleMetadataMinimize()"
                                    title="最小化"
                                >
                                    <span class="metadata-overlay-minimize-icon">▾</span>
                                </button>
                            </div>
                            <div class="metadata-overlay-body" id="metadataOverlayBody">
                                <div class="metadata-overlay-section metadata-overlay-info" id="metadataOverlayInfo">
                                    <div class="metadata-overlay-list" id="metadataOverlayContent"></div>
                                </div>
                                <div class="metadata-overlay-section metadata-overlay-options inactive" id="metadataOverlayOptions">
                                    <div class="metadata-overlay-section-title">表示オプション</div>
                                    <div class="metadata-overlay-toggle-list">
                                        <label class="metadata-overlay-toggle metadata-toggle">
                                            <span>メタデータオーバーレイ</span>
                                            <input type="checkbox" id="metadataLayerToggle" checked onchange="toggleLayer('metadataOverlay', this.checked)">
                                        </label>
                                        <label class="metadata-overlay-toggle metadata-dependent">
                                            <span>1mグリッド</span>
                                            <input type="checkbox" id="gridOverlayToggle" data-option="showGrid" checked onchange="toggleOverlayOption('showGrid', this.checked)">
                                        </label>
                                        <label class="metadata-overlay-toggle metadata-dependent">
                                            <span>原点マーカー</span>
                                            <input type="checkbox" id="originOverlayToggle" data-option="showOrigin" checked onchange="toggleOverlayOption('showOrigin', this.checked)">
                                        </label>
                                        <label class="metadata-overlay-toggle metadata-dependent">
                                            <span>スケールバー</span>
                                            <input type="checkbox" id="scaleOverlayToggle" data-option="showScaleBar" checked onchange="toggleOverlayOption('showScaleBar', this.checked)">
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="map-controls">
                        <button class="load-button" onclick="loadImageFile()">🖼️ 画像を読み込む</button>
                        <button class="load-button" onclick="loadYAMLFile()">📄 YAMLを読み込む</button>
                        <button class="control-button" onclick="toggleDrawingTools()">🎨 描画ツール</button>
                        <button class="control-button" onclick="toggleLayersPanel()">📚 レイヤー</button>
                        <button class="control-button" onclick="undo()" id="undoButton" disabled>↶ 戻る</button>
                        <button class="control-button" onclick="redo()" id="redoButton" disabled>↷ 進む</button>
                        <button class="control-button" onclick="clearMap()">クリア</button>
                        <button class="control-button" onclick="resetView()">表示リセット</button>
                        <button class="control-button" onclick="zoomIn()">拡大 (+)</button>
                        <button class="control-button" onclick="zoomOut()">縮小 (-)</button>
                        <span class="zoom-info" id="zoomInfo">倍率: 100%</span>
                    </div>
                </div>
            </div>

            <div id="stats" class="tab-content">
                <div class="stats" id="statsContent">
                    <div class="loading">統計情報を読み込み中...</div>
                </div>
            </div>

            <div id="operations" class="tab-content">
                <div class="operations" id="operationsContent">
                    <div class="loading">操作カタログを読み込み中...</div>
                </div>
            </div>

            <div id="mapql" class="tab-content">
                <div class="query-section">
                    <input
                        type="text"
                        class="query-input"
                        id="queryInput"
                        placeholder="例: GET Operation FOR 'kitchen_door'"
                    >
                    <button class="query-button" onclick="executeQuery()">クエリ実行</button>
                    <div id="queryResult"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Module -->
    <script type="module" src="js/main.js"></script>
</body>
</html>
