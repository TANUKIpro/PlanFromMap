<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è Semantic Map Platform for HSR</title>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

    <!-- CSS Modules -->
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/layout.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/map-viewer.css">
    <link rel="stylesheet" href="styles/drawing-tools.css">
    <link rel="stylesheet" href="styles/layers-panel.css">
    <link rel="stylesheet" href="styles/metadata-overlay.css">
    <link rel="stylesheet" href="styles/tabs.css">
    <link rel="stylesheet" href="styles/menu-bar.css">
</head>
<body>
    <div class="container">
        <!-- Èö†„Åó„Éï„Ç°„Ç§„É´ÂÖ•Âäõ -->
        <input type="file" id="imageFileInput" accept="image/*,.pgm" style="display: none;" onchange="handleImageFileSelect(event)">
        <input type="file" id="yamlFileInput" accept=".yaml,.yml" style="display: none;" onchange="handleYAMLFileSelect(event)">
        <input type="file" id="profileFileInput" accept=".json" style="display: none;" onchange="handleProfileFileSelect(event)">

        <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„Éä -->
        <div class="tabs-container">
            <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchTab('mapViewer', event)">üó∫Ô∏è „Éû„ÉÉ„Éó„Éì„É•„Éº„Ç¢</button>
                <button class="tab-button" onclick="switchTab('stats', event)">üìä „Ç∑„Çπ„ÉÜ„É†Áµ±Ë®à</button>
                <button class="tab-button" onclick="switchTab('operations', event)">üö™ Êìç‰Ωú„Ç´„Çø„É≠„Ç∞</button>
                <button class="tab-button" onclick="switchTab('mapql', event)">üîç MapQL„ÇØ„Ç®„É™</button>
            </div>

            <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
            <div id="mapViewer" class="tab-content active">
                <div class="map-viewer-tab">
                    <!-- „É°„Éã„É•„Éº„Éê„Éº -->
                    <div class="menu-bar">
                        <!-- „Éï„Ç°„Ç§„É´„É°„Éã„É•„Éº -->
                        <div class="menu-bar__item">
                            <button class="menu-bar__button" onclick="toggleMenu('fileMenu')">„Éï„Ç°„Ç§„É´</button>
                            <div id="fileMenu" class="menu-bar__dropdown">
                                <button class="menu-bar__dropdown-item" onclick="loadImageFile(); closeAllMenus();">ÁîªÂÉè„ÇíË™≠„ÅøËæº„ÇÄ...</button>
                                <button class="menu-bar__dropdown-item" onclick="loadYAMLFile(); closeAllMenus();">YAML„ÇíË™≠„ÅøËæº„ÇÄ...</button>
                                <div class="menu-bar__dropdown-divider"></div>
                                <button class="menu-bar__dropdown-item" onclick="quickSave(); closeAllMenus();">
                                    ‰øùÂ≠ò
                                    <span class="menu-bar__shortcut">Ctrl+S</span>
                                </button>
                                <button class="menu-bar__dropdown-item" onclick="saveAs(); closeAllMenus();">ÂêçÂâç„Çí‰ªò„Åë„Å¶‰øùÂ≠ò...</button>
                                <button class="menu-bar__dropdown-item" onclick="saveAsPGM(); closeAllMenus();">„Éû„ÉÉ„Éó„ÇíPGM„Åß‰øùÂ≠ò...</button>
                                <div class="menu-bar__dropdown-divider"></div>
                                <button class="menu-bar__dropdown-item" onclick="showProfileManager(); closeAllMenus();">„Éó„É≠„Éï„Ç°„Ç§„É´ÁÆ°ÁêÜ</button>
                                <button class="menu-bar__dropdown-item" onclick="importProfile(); closeAllMenus();">„Éó„É≠„Éï„Ç°„Ç§„É´„Çí„Ç§„É≥„Éù„Éº„Éà...</button>
                                <button class="menu-bar__dropdown-item" onclick="exportCurrentProfile(); closeAllMenus();">„Éó„É≠„Éï„Ç°„Ç§„É´„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà...</button>
                                <div class="menu-bar__dropdown-divider"></div>
                                <button class="menu-bar__dropdown-item" onclick="clearMap(); closeAllMenus();">„Éû„ÉÉ„Éó„Çí„ÇØ„É™„Ç¢</button>
                            </div>
                        </div>

                        <!-- Á∑®ÈõÜ„É°„Éã„É•„Éº -->
                        <div class="menu-bar__item">
                            <button class="menu-bar__button" onclick="toggleMenu('editMenu')">Á∑®ÈõÜ</button>
                            <div id="editMenu" class="menu-bar__dropdown">
                                <button class="menu-bar__dropdown-item" id="menuUndoButton" onclick="undo(); closeAllMenus();" disabled>
                                    Êàª„Çã
                                    <span class="menu-bar__shortcut">Ctrl+Z</span>
                                </button>
                                <button class="menu-bar__dropdown-item" id="menuRedoButton" onclick="redo(); closeAllMenus();" disabled>
                                    ÈÄ≤„ÇÄ
                                    <span class="menu-bar__shortcut">Ctrl+Y</span>
                                </button>
                            </div>
                        </div>

                        <!-- Ë°®Á§∫„É°„Éã„É•„Éº -->
                        <div class="menu-bar__item">
                            <button class="menu-bar__button" onclick="toggleMenu('viewMenu')">Ë°®Á§∫</button>
                            <div id="viewMenu" class="menu-bar__dropdown">
                                <button class="menu-bar__dropdown-item" onclick="resetView(); closeAllMenus();">Ë°®Á§∫„É™„Çª„ÉÉ„Éà</button>
                                <button class="menu-bar__dropdown-item" onclick="zoomIn(); closeAllMenus();">
                                    Êã°Â§ß
                                    <span class="menu-bar__shortcut">+</span>
                                </button>
                                <button class="menu-bar__dropdown-item" onclick="zoomOut(); closeAllMenus();">
                                    Á∏ÆÂ∞è
                                    <span class="menu-bar__shortcut">-</span>
                                </button>
                                <div class="menu-bar__dropdown-divider"></div>
                                <div class="menu-bar__dropdown-submenu">
                                    <label class="menu-bar__dropdown-label" for="gridWidthInput">„Ç∞„É™„ÉÉ„ÉâÂπÖ (cm):</label>
                                    <input type="number" id="gridWidthInput" class="menu-bar__dropdown-input" min="1" max="1000" value="10" onchange="updateGridWidth(this.value)">
                                </div>
                                <div class="menu-bar__dropdown-divider"></div>
                                <div class="menu-bar__dropdown-submenu">
                                    <label class="menu-bar__dropdown-checkbox">
                                        <input type="checkbox" id="snapToGridCheckbox" onchange="toggleSnapToGrid(this.checked)">
                                        <span id="snapToGridLabel">„Çπ„Éä„ÉÉ„Éó</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="map-canvas-container" id="mapContainer">
                        <div class="map-placeholder" id="mapPlaceholder">
                            <div style="text-align: center;">
                                <p style="margin-bottom: 20px; color: #999;">„Éó„É≠„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</p>
                            </div>
                        </div>
                        <div id="canvasStack" class="canvas-stack" style="display: none;"></div>
                        <canvas id="mapCanvas" style="display: none;"></canvas>

                        <!-- ÊèèÁîª„ÉÑ„Éº„É´„Éë„É¨„ÉÉ„Éà -->
                        <div class="drawing-tools-palette hidden" id="drawingToolsPalette">
                            <div class="drawing-tools-body">
                                <!-- Â∑¶Âàó: „ÉÑ„Éº„É´„Éú„Çø„É≥ -->
                                <div class="tools-column">
                                    <button class="tool-button active" id="panTool" onclick="selectTool('pan')" title="„Éë„É≥ÔºàÁßªÂãïÔºâ">
                                        <img src="icons/finger-circle.svg" alt="„Éë„É≥" class="tool-icon">
                                    </button>
                                    <button class="tool-button" id="pencilTool" onclick="selectTool('pencil')" title="ÈâõÁ≠Ü">
                                        <img src="icons/pen-1.svg" alt="ÈâõÁ≠Ü" class="tool-icon">
                                    </button>
                                    <button class="tool-button" id="eraserTool" onclick="selectTool('eraser')" title="Ê∂à„Åó„Ç¥„É†">
                                        <img src="icons/eraser.svg" alt="Ê∂à„Åó„Ç¥„É†" class="tool-icon">
                                    </button>
                                    <button class="tool-button" id="measureTool" onclick="selectTool('measure')" title="Ê∏¨Èáè">
                                        <img src="icons/ruler.svg" alt="Ê∏¨Èáè" class="tool-icon">
                                    </button>
                                    <button class="tool-button" id="bucketTool" onclick="selectTool('bucket')" title="Â°ó„Çä„Å§„Å∂„Åó">
                                        <img src="icons/bucket.svg" alt="Â°ó„Çä„Å§„Å∂„Åó" class="tool-icon">
                                    </button>
                                    <div class="tool-divider"></div>
                                    <button class="tool-button" id="rectangleTool" onclick="toggleRectangleToolMode()" title="ÂõõËßíÂΩ¢Ôºà„Ç™„É≥/„Ç™„ÉïÔºâ">
                                        ‚ñ≠
                                    </button>
                                </div>

                                <!-- Âè≥Âàó: „Ç´„É©„Éº„Å®„Éñ„É©„Ç∑„Çµ„Ç§„Ç∫ -->
                                <div class="options-column">
                                    <!-- „Ç´„É©„Éº„Ç¢„Ç§„Ç≥„É≥ -->
                                    <button class="tool-button color-icon-button" id="colorIconButton" onclick="toggleColorPicker()" title="Ëâ≤„ÇíÈÅ∏Êäû">
                                        <div class="color-icon-display" id="colorIconDisplay" style="background-color: #FF0000;"></div>
                                    </button>

                                    <!-- „Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó -->
                                    <div class="color-picker-popup hidden" id="colorPickerPopup">
                                        <div class="color-picker-header">
                                            <button class="color-mode-button active" id="paletteMode" onclick="switchColorMode('palette')" title="„Éë„É¨„ÉÉ„Éà">
                                                <img src="icons/color-grid.svg" alt="„Éë„É¨„ÉÉ„Éà" class="color-mode-icon">
                                            </button>
                                            <button class="color-mode-button" id="rgbMode" onclick="switchColorMode('rgb')" title="RGB">
                                                <img src="icons/color-palette.svg" alt="RGB" class="color-mode-icon">
                                            </button>
                                        </div>
                                        <div class="color-picker-content">
                                            <!-- „Éë„É¨„ÉÉ„Éà„É¢„Éº„Éâ -->
                                            <div class="color-palette" id="colorPalette">
                                                <button class="palette-color active" data-color="#FF0000" style="background-color: #FF0000;" onclick="selectPaletteColor('#FF0000')" title="Ëµ§"></button>
                                                <button class="palette-color" data-color="#00FF00" style="background-color: #00FF00;" onclick="selectPaletteColor('#00FF00')" title="Á∑ë"></button>
                                                <button class="palette-color" data-color="#0000FF" style="background-color: #0000FF;" onclick="selectPaletteColor('#0000FF')" title="Èùí"></button>
                                                <button class="palette-color" data-color="#FFFF00" style="background-color: #FFFF00;" onclick="selectPaletteColor('#FFFF00')" title="ÈªÑ"></button>
                                                <button class="palette-color" data-color="#FF00FF" style="background-color: #FF00FF;" onclick="selectPaletteColor('#FF00FF')" title="„Éû„Çº„É≥„Çø"></button>
                                                <button class="palette-color" data-color="#00FFFF" style="background-color: #00FFFF;" onclick="selectPaletteColor('#00FFFF')" title="„Ç∑„Ç¢„É≥"></button>
                                                <button class="palette-color" data-color="#FFA500" style="background-color: #FFA500;" onclick="selectPaletteColor('#FFA500')" title="„Ç™„É¨„É≥„Ç∏"></button>
                                                <button class="palette-color" data-color="#800080" style="background-color: #800080;" onclick="selectPaletteColor('#800080')" title="Á¥´"></button>
                                                <button class="palette-color" data-color="#000000" style="background-color: #000000;" onclick="selectPaletteColor('#000000')" title="Èªí"></button>
                                                <button class="palette-color" data-color="#FFFFFF" style="background-color: #FFFFFF; border: 1px solid #ccc;" onclick="selectPaletteColor('#FFFFFF')" title="ÁôΩ"></button>
                                            </div>
                                            <!-- RGB„É¢„Éº„Éâ -->
                                            <div class="color-rgb hidden" id="colorRGB">
                                                <input type="color" class="color-picker-input" id="colorPicker" value="#FF0000" onchange="changeDrawingColor(this.value)">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- „Éñ„É©„Ç∑„Çµ„Ç§„Ç∫„Ç≥„É≥„Éà„É≠„Éº„É´ÔºàÁ∏¶ÊñπÂêëÔºâ -->
                                    <div class="brush-size-control-vertical">
                                        <input type="range" class="brush-size-slider-vertical" id="brushSizeSlider" min="1" max="50" value="5" oninput="changeBrushSize(this.value)" orient="vertical">
                                        <div class="brush-size-label-vertical">
                                            <span id="brushSizeValue">5</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="drawing-tools-toggle" id="drawingToolsToggle" onclick="toggleDrawingToolsVisibility()" title="ÊèèÁîª„ÉÑ„Éº„É´„ÇíË°®Á§∫/ÈùûË°®Á§∫">
                                <img src="icons/arrow-left.svg" alt="Êäò„Çä„Åü„Åü„ÇÄ" class="toggle-arrow-icon">
                            </button>
                        </div>

                        <!-- „É¨„Ç§„É§„Éº„Éë„Éç„É´ -->
                        <div class="layers-panel hidden" id="layersPanel">
                            <button class="layers-panel-toggle" id="layersPanelToggle" onclick="toggleLayersPanelVisibility()" title="„É¨„Ç§„É§„Éº„ÇíË°®Á§∫/ÈùûË°®Á§∫">
                                <img src="icons/arrow-right.svg" alt="Â±ïÈñã" class="toggle-arrow-icon">
                            </button>
                            <div class="layers-panel-header">
                                <span class="layers-panel-title">
                                    üìö „É¨„Ç§„É§„Éº
                                </span>
                                <button class="layer-add-button" onclick="addNewLayer()" title="Êñ∞„Åó„ÅÑ„É¨„Ç§„É§„Éº„ÇíËøΩÂä†">
                                    <img src="icons/add-01.svg" alt="ËøΩÂä†" class="layer-add-icon">
                                </button>
                            </div>
                            <div class="layers-panel-body" id="layersPanelBody">
                                <!-- „É¨„Ç§„É§„Éº„Ç¢„Ç§„ÉÜ„É†„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                            </div>
                            <div class="layers-panel-footer">
                                <div class="global-opacity-control">
                                    <input type="range" class="global-opacity-slider" id="globalOpacitySlider"
                                           min="0" max="1" step="0.01" value="1.0">
                                    <span class="global-opacity-value" id="globalOpacityValue">100%</span>
                                </div>
                            </div>
                        </div>

                        <!-- ÂõõËßíÂΩ¢Ê∏¨ÈáèÂÖ•ÂäõUI -->
                        <div class="edge-length-input-ui" id="edgeLengthInputUI" style="display: none;">
                            <div class="edge-length-input-container">
                                <input type="number" id="edgeLengthInput" class="edge-length-input" step="0.1" min="0.1" placeholder="Èï∑„Åï (cm)">
                                <div class="edge-length-input-buttons">
                                    <button id="edgeLengthConfirm" class="edge-length-button confirm">‚úì</button>
                                    <button id="edgeLengthCancel" class="edge-length-button cancel">‚úï</button>
                                </div>
                            </div>
                        </div>

                        <div class="metadata-overlay-panel minimized" id="metadataOverlay" aria-hidden="true">
                            <div class="metadata-overlay-header" onclick="toggleMetadataMinimize()" data-tooltip="„Éû„ÉÉ„Éó„É°„Çø„Éá„Éº„Çø">
                                <span class="metadata-overlay-icon">
                                    <img src="icons/map.svg" alt="„Éû„ÉÉ„Éó" class="metadata-icon">
                                </span>
                                <span class="metadata-overlay-title">üìã „Éû„ÉÉ„Éó„É°„Çø„Éá„Éº„Çø</span>
                                <button
                                    type="button"
                                    class="metadata-overlay-minimize"
                                    onclick="event.stopPropagation(); toggleMetadataMinimize()"
                                    title="ÊúÄÂ∞èÂåñ"
                                >
                                    <span class="metadata-overlay-minimize-icon">‚ñæ</span>
                                </button>
                            </div>
                            <div class="metadata-overlay-body" id="metadataOverlayBody">
                                <div class="metadata-overlay-section metadata-overlay-info" id="metadataOverlayInfo">
                                    <div class="metadata-overlay-list" id="metadataOverlayContent"></div>
                                </div>
                                <div class="metadata-overlay-section metadata-overlay-options inactive" id="metadataOverlayOptions">
                                    <div class="metadata-overlay-section-title">Ë°®Á§∫„Ç™„Éó„Ç∑„Éß„É≥</div>
                                    <div class="metadata-overlay-toggle-list">
                                        <label class="metadata-overlay-toggle metadata-toggle">
                                            <span>„É°„Çø„Éá„Éº„Çø„Ç™„Éº„Éê„Éº„É¨„Ç§</span>
                                            <input type="checkbox" id="metadataLayerToggle" checked onchange="toggleLayer('metadataOverlay', this.checked)">
                                        </label>
                                        <label class="metadata-overlay-toggle metadata-dependent">
                                            <span>1m„Ç∞„É™„ÉÉ„Éâ</span>
                                            <input type="checkbox" id="gridOverlayToggle" data-option="showGrid" checked onchange="toggleOverlayOption('showGrid', this.checked)">
                                        </label>
                                        <label class="metadata-overlay-toggle metadata-dependent">
                                            <span>ÂéüÁÇπ„Éû„Éº„Ç´„Éº</span>
                                            <input type="checkbox" id="originOverlayToggle" data-option="showOrigin" checked onchange="toggleOverlayOption('showOrigin', this.checked)">
                                        </label>
                                        <label class="metadata-overlay-toggle metadata-dependent">
                                            <span>„Çπ„Ç±„Éº„É´„Éê„Éº</span>
                                            <input type="checkbox" id="scaleOverlayToggle" data-option="showScaleBar" checked onchange="toggleOverlayOption('showScaleBar', this.checked)">
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº -->
                        <div class="status-bar" id="statusBar">
                            <div class="status-bar-section">
                                <span class="status-bar-label">„Éï„Ç°„Ç§„É´:</span>
                                <span class="status-bar-value" id="statusFileName">-</span>
                            </div>
                            <div class="status-bar-section">
                                <span class="status-bar-label">„Ç´„Éº„ÇΩ„É´:</span>
                                <span class="status-bar-value" id="statusCursor">-</span>
                            </div>
                            <div class="status-bar-section">
                                <span class="status-bar-label">„É¨„Ç§„É§„Éº:</span>
                                <span class="status-bar-value" id="statusLayer">-</span>
                            </div>
                            <div class="status-bar-section status-bar-metadata" id="statusMetadata">
                                <span class="status-bar-label">Ëß£ÂÉèÂ∫¶:</span>
                                <span class="status-bar-value" id="statusResolution">-</span>
                                <span class="status-bar-separator">|</span>
                                <span class="status-bar-label">ÂéüÁÇπ:</span>
                                <span class="status-bar-value" id="statusOrigin">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="stats" class="tab-content">
                <div class="stats" id="statsContent">
                    <div class="loading">Áµ±Ë®àÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>
            </div>

            <div id="operations" class="tab-content">
                <div class="operations" id="operationsContent">
                    <div class="loading">Êìç‰Ωú„Ç´„Çø„É≠„Ç∞„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                </div>
            </div>

            <div id="mapql" class="tab-content">
                <div class="query-section">
                    <input
                        type="text"
                        class="query-input"
                        id="queryInput"
                        placeholder="‰æã: GET Operation FOR 'kitchen_door'"
                    >
                    <button class="query-button" onclick="executeQuery()">„ÇØ„Ç®„É™ÂÆüË°å</button>
                    <div id="queryResult"></div>
                </div>
            </div>
        </div>

        <!-- „Éó„É≠„Éï„Ç°„Ç§„É´ÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ -->
        <div id="profileManagerModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üíæ „Éó„É≠„Éï„Ç°„Ç§„É´ÁÆ°ÁêÜ</h2>
                    <button class="modal-close" onclick="closeProfileManager()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="profile-section">
                        <h3>ÁèæÂú®„ÅÆ„Éó„É≠„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò</h3>
                        <div class="profile-save-form">
                            <input type="text" id="profileNameInput" placeholder="„Éó„É≠„Éï„Ç°„Ç§„É´Âêç„ÇíÂÖ•Âäõ" class="profile-input">
                            <button onclick="saveCurrentProfile()" class="profile-button save">‰øùÂ≠ò</button>
                        </div>
                    </div>
                    <div class="profile-section">
                        <h3>‰øùÂ≠ò„Åï„Çå„Åü„Éó„É≠„Éï„Ç°„Ç§„É´</h3>
                        <div id="profileList" class="profile-list">
                            <!-- „Éó„É≠„Éï„Ç°„Ç§„É´‰∏ÄË¶ß„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Module -->
    <script type="module" src="js/main.js"></script>
</body>
</html>
