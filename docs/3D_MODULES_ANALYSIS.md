# 3D関連モジュールの分析と改善提案

## 現状の実装概要

### モジュール構成

1. **threeDModels.js** (1945行)
   - メインビュー用とプレビュー用の描画関数が重複
   - 各オブジェクトタイプ（棚、箱、テーブル、扉、壁）の描画ロジック
   - Painter's Algorithmを使用した深度ソート描画

2. **threeDViewCore.js** (1178行)
   - メイン3Dビューの管理とイベント処理
   - Canvas 2Dコンテキストを使用
   - 等角投影（Isometric Projection）
   - マウス操作、ホイール操作、オブジェクト選択

3. **threeDPreview.js** (430行)
   - プロパティパネル用3Dプレビュー管理
   - ホイールでズーム操作
   - グリッド描画、前面方向矢印描画

4. **threeDUtils.js** (189行)
   - 等角投影変換
   - 色操作（明るく/暗く）
   - 深度計算・ソート

5. **threeDRenderer.js** (68行)
   - 後方互換性用の再エクスポートモジュール

6. **viewCube.js** (337行)
   - ViewCube（視点切り替えコントロール）

### 問題点

1. **コードの重複**
   - メインビュー用とプレビュー用の描画関数がほぼ同じ実装
   - 各オブジェクトタイプごとに類似したコードが繰り返される

2. **非効率な描画手法**
   - Painter's Algorithmは古い手法で、毎フレーム全面をソート
   - 面ごとに個別に描画関数を定義しており、メモリ使用量が多い

3. **複雑な依存関係**
   - モジュール間の依存が複雑
   - 状態管理が分散している

4. **パフォーマンス**
   - 毎フレーム全オブジェクトを再描画
   - キャッシュが不十分

## 改善提案と実装状況

### 1. 共通描画ロジックの統合 ✅ 実装済み

**実装内容:**
- 新しい`threeDGeometry.js`モジュールを作成
- 共通のボックス描画ロジックを`createBoxGeometry`として抽出
- 棚、テーブル用の専用ジオメトリ生成関数を追加
- メインビュー用の描画関数（`draw3DShelf`, `draw3DBox`, `draw3DTable`, `drawBox`）を簡素化

**効果:**
- `threeDModels.js`のコード量を大幅に削減（約140行削減）
- 重複コードを削減し、保守性が向上
- 一貫した描画ロジックにより、バグの発生リスクを低減

### 2. 描画パフォーマンスの最適化 ⏳ 進行中

**実装予定:**
- 変更されたオブジェクトのみ再描画
- 面のソートを最適化（必要最小限の面のみソート）
- 描画結果のキャッシュ

### 3. モジュール構造の簡素化 ⏳ 進行中

**実装予定:**
- 描画ロジックと状態管理を分離
- 共通ユーティリティの集約
- プレビュー用描画関数の簡素化

### 4. コードの簡素化 ✅ 実装済み

**実装内容:**
- 重複コードの削減（メインビュー用関数を簡素化）
- より宣言的な描画API（`createBoxGeometry`など）

## 実装された改善の詳細

### 新しいモジュール: `threeDGeometry.js`

共通の3Dジオメトリ描画ロジックを提供するモジュール。

**主な関数:**
- `createBoxGeometry`: ボックスジオメトリの作成
- `drawBoxFaces`: ボックスの面を描画（深度ソート済み）
- `createShelfGeometry`: 棚ジオメトリの作成（前面が開いている）
- `createTableGeometry`: テーブルジオメトリの作成（天板と脚）

**利点:**
- メインビューとプレビューで共通のロジックを使用可能
- コードの重複を削減
- テストが容易

### 簡素化された描画関数

**Before (例: drawBox):**
```javascript
// 約140行のコード
// 頂点計算、面の定義、深度ソート、描画をすべて含む
```

**After:**
```javascript
export function drawBox(ctx, coords3D, color, centerX, centerY, worldToIso, state) {
    const geometry = createBoxGeometry(coords3D, worldToIso, centerX, centerY, state, { color });
    drawBoxFaces(ctx, geometry, state);
}
```

**削減効果:**
- `drawBox`: 約140行 → 3行
- `draw3DShelf`: 約200行 → 約15行
- `draw3DBox`: 約120行 → 5行
- `draw3DTable`: 約270行 → 7行

