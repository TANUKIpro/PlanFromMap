# 2Dマップエディタ - オブジェクトプロパティ管理

## 概要

2Dマップエディタは、占有格子マップ上に家具やオブジェクトの詳細情報を付与し、3D空間モデルを構築するための統合システムです。単なる2D地図ではなく、物理的な高さ、前面方向、オブジェクトの種類など、ロボットが環境を理解するために必要な意味情報を管理します。

### 主要機能

1. **オブジェクトプロパティ管理** - 家具・オブジェクトの詳細設定
2. **リアルタイム3Dプレビュー** - プロパティに応じた即座の視覚的フィードバック
3. **カテゴリ別3Dモデル** - オブジェクトタイプに応じた特徴的な3D表現
4. **2D視覚的フィードバック** - 斜線パターンと方向矢印による視認性向上
5. **オブジェクトカタログ** - マップ上の全オブジェクトを一覧表示・管理（独立タブ）

---

## オブジェクトプロパティシステム

### サポートされるオブジェクトカテゴリ

| カテゴリ | 説明 | 3Dモデルの特徴 | 用途例 |
|---------|------|--------------|-------|
| **棚 (Shelf)** | 開口部を持つ収納家具 | 前面が開いた長方形、棚板表示 | 本棚、キャビネット、オープンシェルフ |
| **箱 (Box)** | 蓋が開いた容器 | 上部が開いた5面体 | 収納ボックス、引き出し、コンテナ |
| **テーブル (Table)** | 天板と脚を持つ家具 | 天板（10%厚）+ 4本の脚 | ダイニングテーブル、作業台、デスク |
| **扉 (Door)** | 薄い可動パネル | 薄型長方形（depth最小化） | ドア、間仕切り、扉付き家具 |
| **壁 (Wall)** | 固定された構造物 | 標準長方形 | 壁、パーティション、固定構造 |
| **なし (None)** | 未分類オブジェクト | デフォルト長方形 | 未設定、一時的なマーカー |

---

## 基本的な使い方

### 1. オブジェクトの作成

```
1. 描画ツールから「四角形描画」を選択
2. マップ上でドラッグして四角形を作成
3. 作成した四角形が自動的に選択される
4. 右側にオブジェクトプロパティパネルが表示される
```

### 2. プロパティパネルの構成

プロパティパネルは以下のセクションで構成されています：

#### **3Dプレビュー（最上部）**
- リアルタイム更新される3D表示
- プロパティ変更が即座に反映
- 読み取り専用（マウス操作不可）
- 入力パラメータの確認用

#### **基本情報**
- **オブジェクトカテゴリ**: ドロップダウンで選択
- **高さ (m)**: 物理的な高さをメートル単位で指定
- **前面方向**: オブジェクトの開口部や正面の向き

#### **カテゴリ別詳細設定**
選択したカテゴリに応じて動的に表示される専用設定項目

---

## カテゴリ別詳細設定

### 棚 (Shelf)

棚は前面が開いた収納家具を表現します。前面方向に応じて開口部の向きが変わります。

#### プロパティ

| プロパティ | 説明 | 範囲 | デフォルト |
|-----------|------|------|----------|
| **段数 (Shelf Levels)** | 棚板の段数 | 1-10 | 3 |
| **仕切り数 (Dividers)** | 各段の縦仕切り数 | 0-5 | 0 |
| **棚タイプ (Shelf Type)** | 開放型 or 扉付き | open/closed | open |

#### 3Dモデルの特徴

- 前面方向に応じた開口部（上/下/左/右）
- 段数に応じた棚板の3D表示
- 側面、背面、上面、底面を持つ箱型構造

#### 使用例

```
本棚の場合:
- カテゴリ: 棚
- 高さ: 1.8m
- 前面方向: 上（top）
- 段数: 5
- 仕切り数: 2
- 棚タイプ: 開放型

→ 高さ1.8mの5段オープンシェルフとして3D表示
```

### 箱 (Box)

箱は上部が開いた容器を表現します。

#### プロパティ

| プロパティ | 説明 | 範囲 | デフォルト |
|-----------|------|------|----------|
| **蓋 (Has Lid)** | 蓋の有無 | true/false | false |
| **取っ手 (Handles)** | 取っ手の数 | 0-4 | 2 |
| **材質 (Material)** | 素材タイプ | plastic/wood/metal/cardboard | plastic |

#### 3Dモデルの特徴

- 上部が開いた5面体（上面なし）
- 底面と4つの側面のみ描画
- 内部が見える構造

#### 使用例

```
収納ボックスの場合:
- カテゴリ: 箱
- 高さ: 0.3m
- 蓋: なし
- 取っ手: 2
- 材質: プラスチック

→ 高さ30cmの上部開放型収納ボックスとして3D表示
```

### テーブル (Table)

テーブルは天板と脚を持つ家具を表現します。

#### プロパティ

| プロパティ | 説明 | 範囲 | デフォルト |
|-----------|------|------|----------|
| **脚の数 (Legs)** | 脚の本数 | 1/3/4 | 4 |
| **天板形状 (Top Shape)** | 天板の形 | rectangular/round | rectangular |
| **引き出し (Drawers)** | 引き出しの数 | 0-3 | 0 |

#### 3Dモデルの特徴

- 天板: 高さの10%の厚さ
- 脚: 幅・奥行きの小さい方の10%の太さ
- 4本脚の場合、四隅に配置
- 天板下から地面まで脚を描画

#### 使用例

```
ダイニングテーブルの場合:
- カテゴリ: テーブル
- 高さ: 0.75m
- 脚の数: 4
- 天板形状: 長方形
- 引き出し: 0

→ 高さ75cmの4本脚テーブルとして3D表示
```

### 扉 (Door)

扉は薄い可動パネルを表現します。

#### プロパティ

| プロパティ | 説明 | 範囲 | デフォルト |
|-----------|------|------|----------|
| **開き方 (Opening)** | 開く方向 | push/pull/slide | push |
| **取っ手側 (Handle Side)** | 取っ手の位置 | left/right | right |
| **自動ドア (Automatic)** | 自動開閉 | true/false | false |

#### 3Dモデルの特徴

- 非常に薄い長方形（depth最小化）
- 前面の大きな面を強調
- 側面は最小限の厚さ

#### 使用例

```
玄関ドアの場合:
- カテゴリ: 扉
- 高さ: 2.0m
- 開き方: 引く（pull）
- 取っ手側: 右
- 自動ドア: いいえ

→ 高さ2mの薄型ドアとして3D表示
```

### 壁 (Wall)

壁は固定された構造物を表現します。

#### プロパティ

| プロパティ | 説明 | 範囲 | デフォルト |
|-----------|------|------|----------|
| **壁厚 (Thickness)** | 壁の厚さ（cm） | 5-30 | 15 |
| **材質 (Material)** | 素材 | concrete/wood/drywall/glass | drywall |
| **窓 (Windows)** | 窓の数 | 0-5 | 0 |

#### 3Dモデルの特徴

- 標準的な直方体
- 特別な開口部なし
- 全6面を描画

#### 使用例

```
間仕切り壁の場合:
- カテゴリ: 壁
- 高さ: 2.4m
- 壁厚: 10cm
- 材質: 石膏ボード
- 窓: 1

→ 高さ2.4mの壁として3D表示
```

---

## 3Dプレビューシステム

### プロパティパネル内プレビュー

**目的**: 入力パラメータの即座の視覚的確認

**特徴**:
- プロパティ変更時にリアルタイム更新
- 読み取り専用（マウス操作不可）
- コンパクトな固定ビュー（180px高さ）
- オブジェクト単体を中央配置

**更新タイミング**:
- カテゴリ変更時
- 高さ変更時
- 前面方向変更時
- カテゴリ別プロパティ変更時

**表示内容**:
- 簡易グリッド（床面）
- オブジェクトの3Dモデル
- 前面方向矢印

### メイン3Dビュー

**目的**: マップ全体の3D空間表現

**特徴**:
- マウスドラッグで回転
- ホイールでズーム
- 全オブジェクトを一度に表示
- 等角投影による正確な寸法表現

**操作方法**:

```
回転: マウス左ドラッグ（右方向にドラッグするとシーンが右に回転）
ズーム: マウスホイール
リセット: 3Dビューを閉じて再度開く
```

**表示内容**:
- 1mグリッド（床面）
- 全オブジェクトの3Dモデル
- 前面方向矢印
- オブジェクトタイプ別色分け

---

## 2D視覚的フィードバック

### 斜線パターン

**目的**: カテゴリと高さが設定されたオブジェクトの識別

**条件**:
- `objectType !== 'none'`
- `heightMeters > 0`

**表示**:
- オブジェクト色の対角線パターン
- 透明度20%
- 10px間隔
- 四角形内部のみ

**効果**:
- 設定済みオブジェクトの一目での識別
- 未設定オブジェクトとの明確な区別

### 前面方向矢印

**目的**: オブジェクトの向きの可視化

**条件**:
- `frontDirection` が設定されている
- `objectType !== 'none'`

**表示**:
- オブジェクトの前面エッジに矢印
- 矢印サイズ: 四角形サイズの40%
- オブジェクトの色と同色
- 透明度80%

**向き**:
- **上 (top)**: 上辺に上向き矢印
- **下 (bottom)**: 下辺に下向き矢印
- **左 (left)**: 左辺に左向き矢印
- **右 (right)**: 右辺に右向き矢印

---

## プロパティパネルの操作

### スクロール動作

プロパティパネル内でのマウスホイールスクロールは、パネル内部のみに作用します。背後のマップのズームには影響しません。

**技術的実装**:
- ホイールイベントの伝播を停止（`stopPropagation()`）
- パネル内スクロールのみを許可
- マップ操作との干渉を防止

### リアルタイム更新

すべてのプロパティ変更は以下を即座に更新します：

1. **プロパティパネル内3Dプレビュー**
2. **メイン3Dビュー**（開いている場合）
3. **2Dマップ表示**（斜線パターン、矢印）

### 入力タイプ

#### 数値入力（高さ、段数など）

- 直接入力フィールド
- スライダー（範囲が定義されている場合）
- リアルタイム検証
- 範囲外の値は自動的に補正

#### 選択式（カテゴリ、前面方向など）

- ドロップダウンメニュー
- ラジオボタン（2-4択の場合）
- 変更時に即座に反映

#### チェックボックス（蓋の有無など）

- ON/OFF切り替え
- デフォルト値あり
- 変更時に即座に反映

---

## 座標系と単位

### 2Dマップ座標系

- **原点**: マップ画像の左上
- **X軸**: 右方向が正
- **Y軸**: 下方向が正
- **単位**: ピクセル（内部でメートルに変換）

### 3D空間座標系

- **原点**: マップ原点と同一（Z=0が床面）
- **X軸**: 右方向が正（2Dマップと同じ）
- **Y軸**: 奥方向が正（2DマップのY軸と同じ）
- **Z軸**: 上方向が正
- **単位**: メートル

**等角投影での表示**:
3Dビューでは等角投影を使用しており、2Dマップと同じ位置関係で表示されます。マップテクスチャ、原点、オブジェクトの配置は2Dビューと完全に一致します。

### 単位換算

```javascript
// ピクセル → メートル
メートル = ピクセル × 解像度(m/pixel)

// デフォルト解像度: 0.05m/pixel
1ピクセル = 5cm
20ピクセル = 1m
```

---

## 前面方向の概念

### 方向の定義

前面方向は、オブジェクトの「正面」または「開口部」の向きを示します。

| 方向キー | 説明 | 2Dマップ上の向き | 用途例 |
|---------|------|----------------|-------|
| **top** | 上 | マップ上部 | 北向きの棚、上開きの扉 |
| **bottom** | 下 | マップ下部 | 南向きの棚、下開きの扉 |
| **left** | 左 | マップ左側 | 西向きの棚、左開きの扉 |
| **right** | 右 | マップ右側 | 東向きの棚、右開きの扉 |

### カテゴリ別の意味

#### 棚 (Shelf)
前面 = 開口部の向き

```
前面方向: 上 → 上側が開いている
前面方向: 右 → 右側が開いている
```

#### 箱 (Box)
前面 = 主な取り出し側（上部開放は固定）

```
前面方向: 上 → 正面から見たときの向き
```

#### テーブル (Table)
前面 = 使用者が座る側

```
前面方向: 下 → 下側に椅子を配置
```

#### 扉 (Door)
前面 = 取っ手がある側、開く方向

```
前面方向: 左 → 左に開く扉
前面方向: 右 → 右に開く扉
```

---

## ワークフロー例

### 例1: キッチンの棚を登録

```
1. 四角形ツールで棚の位置を2Dマップ上に描画
   - 幅: 800mm (約16ピクセル)
   - 奥行き: 400mm (約8ピクセル)

2. プロパティパネルで設定
   - カテゴリ: 棚
   - 高さ: 1.8m
   - 前面方向: 上（キッチン側に開く）
   - 段数: 5
   - 仕切り数: 0
   - 棚タイプ: 開放型

3. 3Dプレビューで確認
   - 高さ1.8mの5段棚が表示される
   - 前面（上側）が開いていることを確認
   - 棚板が5段に分かれていることを確認

4. 2Dマップで確認
   - 斜線パターンが表示される
   - 上辺に上向き矢印が表示される

5. 保存（自動）
```

### 例2: リビングのテーブルを登録

```
1. 四角形ツールでテーブルの位置を描画
   - 幅: 1200mm (約24ピクセル)
   - 奥行き: 800mm (約16ピクセル)

2. プロパティパネルで設定
   - カテゴリ: テーブル
   - 高さ: 0.75m
   - 前面方向: 下（椅子を配置する側）
   - 脚の数: 4
   - 天板形状: 長方形
   - 引き出し: 0

3. 3Dプレビューで確認
   - 高さ75cmのテーブルが表示される
   - 天板と4本の脚が見える
   - 天板の厚さが適切（約7.5cm）

4. 2Dマップで確認
   - 斜線パターンが表示される
   - 下辺に下向き矢印が表示される

5. メイン3Dビューで空間全体を確認
   - テーブルと周囲の家具の位置関係を確認
   - 高さの違いを視覚的に把握
```

### 例3: 玄関のドアを登録

```
1. 四角形ツールでドアの位置を描画
   - 幅: 900mm (約18ピクセル)
   - 奥行き: 100mm (約2ピクセル、薄い)

2. プロパティパネルで設定
   - カテゴリ: 扉
   - 高さ: 2.0m
   - 前面方向: 右（右に開く）
   - 開き方: 引く
   - 取っ手側: 右
   - 自動ドア: いいえ

3. 3Dプレビューで確認
   - 高さ2mの薄型ドアが表示される
   - 非常に薄い構造を確認

4. 2Dマップで確認
   - 斜線パターンが表示される
   - 右辺に右向き矢印が表示される
```

---

## データ構造

### オブジェクトデータモデル

各四角形オブジェクトは以下の構造で保存されます：

```javascript
{
  // 基本情報
  id: "rect-0",
  x: 100,              // マップ上のX座標（ピクセル）
  y: 200,              // マップ上のY座標（ピクセル）
  width: 50,           // 幅（ピクセル）
  height: 30,          // 奥行き（ピクセル）
  rotation: 0,         // 回転角度（度）
  color: "#667eea",    // 表示色
  selected: false,     // 選択状態

  // オブジェクト情報
  objectType: "shelf",           // カテゴリ
  heightMeters: 1.8,             // 高さ（メートル）
  frontDirection: "top",         // 前面方向

  // カテゴリ別プロパティ
  objectProperties: {
    shelfLevels: 5,              // 棚固有
    shelfDividers: 0,
    shelfType: "open"
  }
}
```

### プロパティスキーマ

各カテゴリのプロパティはスキーマで定義されています：

```javascript
PROPERTY_SCHEMAS.shelf = {
  shelfLevels: {
    label: "段数",
    type: "number",
    min: 1,
    max: 10,
    default: 3,
    hasSlider: true
  },
  shelfDividers: {
    label: "仕切り数",
    type: "number",
    min: 0,
    max: 5,
    default: 0,
    hasSlider: true
  },
  shelfType: {
    label: "棚タイプ",
    type: "select",
    options: [
      { value: "open", label: "開放型" },
      { value: "closed", label: "扉付き" }
    ],
    default: "open"
  }
}
```

---

## トラブルシューティング

### Q1: プロパティパネルをスクロールするとマップがズームしてしまう

**回答**: これは修正済みの問題です。最新バージョンではプロパティパネル内のスクロールはパネル内部のみに作用し、マップには影響しません。

### Q2: 3Dプレビューが表示されない

**確認項目**:
1. カテゴリが選択されているか
2. 高さが0より大きいか
3. ブラウザコンソールにエラーが出ていないか

**対処**:
- カテゴリを一度「なし」に戻してから再設定
- ページをリロード

### Q3: 前面方向矢印が表示されない

**確認項目**:
1. 前面方向が選択されているか
2. カテゴリが「なし」以外か
3. 四角形が選択解除されていないか

### Q4: カテゴリ別プロパティが表示されない

**確認項目**:
1. カテゴリが選択されているか
2. JavaScriptコンソールにエラーがないか

**対処**:
- ブラウザのキャッシュをクリア
- ページをリロード

### Q5: 3Dモデルの形状が意図と異なる

**確認項目**:
1. 2Dマップ上の四角形の幅と高さ（奥行き）
2. 高さの値
3. 前面方向の設定

**ヒント**:
- 棚の「幅 × 奥行き × 高さ」が現実の寸法と合っているか
- 前面方向が意図した向きと一致しているか

### Q6: オブジェクトの色を変更できない

**回答**: オブジェクトの色はカテゴリによって自動的に決定されます。

カテゴリ別の色:
- なし: グレー (#94a3b8)
- 棚: 紫 (#667eea)
- 箱: オレンジ (#ed8936)
- テーブル: 緑 (#48bb78)
- 扉: 青 (#4299e1)
- 壁: 茶 (#a0aec0)

---

## ベストプラクティス

### 1. 適切な解像度での描画

```
推奨:
- 実寸法に基づいてサイズを決定
- 1m = 20ピクセルを目安に

例: 1.2m × 0.8mのテーブル
→ 24ピクセル × 16ピクセル
```

### 2. カテゴリの選択基準

```
迷った場合:
- 開口部がある → 棚
- 上部が開いている → 箱
- 天板と脚 → テーブル
- 薄くて可動 → 扉
- 固定された仕切り → 壁
```

### 3. 前面方向の設定

```
基準:
- 人がアクセスする側を前面に
- ロボットがアプローチする方向
- 物の出し入れをする側
```

### 4. 高さの設定

```
一般的な高さの目安:
- 棚: 0.5m - 2.5m
- 箱: 0.2m - 0.6m
- テーブル: 0.7m - 0.8m
- 扉: 1.8m - 2.2m
- 壁: 2.0m - 2.8m
```

### 5. プロパティの一貫性

```
同じ種類の家具は同じ設定を使用:
- IKEA BILLYシリーズ → 段数5、開放型
- 無印良品のスタッキングシェルフ → 段数3、仕切り0
```

---

## 技術的詳細

### モジュール構成

| モジュール | 行数 | 責務 |
|-----------|------|------|
| objectTypes.js | 500行 | オブジェクトタイプ定義、スキーマ |
| rectangleManager.js | 350行 | 四角形のライフサイクル管理 |
| rectangleRenderer.js | 400行 | 2D描画（斜線、矢印含む） |
| objectPropertyManager.js | 350行 | プロパティのビジネスロジック |
| objectPropertyPanel.js | 600行 | プロパティパネルUI制御 |
| threeDRenderer.js | 1200行 | 3D描画（等角投影、モデル描画） |

### 3D描画アルゴリズム

#### 等角投影（Isometric Projection）

```javascript
// 3D座標(x, y, z) → 2D画面座標(screenX, screenY)
function worldToIso(x, y, z) {
  const rad = rotation * Math.PI / 180;
  const tiltRad = tilt * Math.PI / 180;

  const rotX = x * Math.cos(rad) - y * Math.sin(rad);
  const rotY = x * Math.sin(rad) + y * Math.cos(rad);

  return {
    x: -rotX,  // X軸を反転して2Dマップとの整合性を確保
    y: z - rotY * Math.sin(tiltRad)
  };
}
```

**座標系の統一**:
等角投影変換ではX軸を反転することで、3D表示が2Dマップと同じ向きになります。これにより、マップテクスチャ、原点、家具の配置が2Dビューと完全に一致します。

#### カテゴリ別描画の分岐

```javascript
function draw3DModel(ctx, coords3D, color, objectType, frontDirection, properties) {
  switch (objectType) {
    case 'shelf':
      draw3DShelf(ctx, coords3D, color, frontDirection, properties);
      break;
    case 'box':
      draw3DBox_Hollowed(ctx, coords3D, color, frontDirection, properties);
      break;
    // ... 他のカテゴリ
  }
}
```

### パフォーマンス最適化

1. **差分更新**: プロパティ変更時のみ再描画
2. **Canvas状態管理**: `save()`/`restore()`による適切なスコープ管理
3. **イベント伝播制御**: 不要な再描画を防止
4. **非同期import**: 動的モジュールロードによる初期ロード高速化

---

---

## オブジェクトカタログ

### 概要

オブジェクトカタログは、マップ上に配置された全オブジェクトを一覧表示し、詳細な編集を行うための専用タブです。2Dマップビューアとは独立したメインタブとして提供されており、効率的にオブジェクトを管理できます。

### アクセス方法

```
トップメニュー: 🗺️ マップビューア → 📚 オブジェクトカタログ → 🚪 操作カタログ → 🔍 MapQLクエリ
```

オブジェクトカタログは、マップビューアと操作カタログの間に配置されています。

### 画面構成

オブジェクトカタログは左右2分割のレイアウトです：

#### 左パネル: オブジェクト一覧

- **ヘッダー**: タイトルと説明
- **フィルタ**: カテゴリによる絞り込み（すべて/棚/箱/テーブル/扉/壁/未設定）
- **オブジェクトリスト**:
  - オブジェクトID
  - カテゴリバッジ（色分け）
  - サイズ情報（幅×奥行き）
  - 高さ情報
  - 前面方向

#### 右パネル: 3Dプレビュー & 詳細編集

- **3Dプレビューセクション**: 選択したオブジェクトの3Dモデルをリアルタイム表示
  - マウスドラッグで回転（右方向にドラッグするとシーンが右に回転）
  - マウスホイールでズーム
- **ViewCube**: 3Dビューの角度調整
- **詳細編集パネル**: オブジェクトのプロパティを編集（保存/キャンセル）

### 使い方

#### 1. オブジェクトの検索と選択

```
1. カテゴリフィルタで絞り込み（例: 「棚」のみ表示）
2. リストからオブジェクトをクリック
3. 右パネルに3Dプレビューと詳細情報が表示される
```

#### 2. オブジェクトの編集

```
1. オブジェクトを選択
2. 右パネルの「詳細編集」で各プロパティを変更
3. 3Dプレビューでリアルタイムに確認
4. 「保存」ボタンで確定、または「キャンセル」で破棄
```

#### 3. カテゴリフィルタの活用

- **すべて**: 全オブジェクトを表示
- **棚**: 棚のみ表示
- **箱**: 箱のみ表示
- **テーブル**: テーブルのみ表示
- **扉**: 扉のみ表示
- **壁**: 壁のみ表示
- **未設定**: カテゴリが設定されていないオブジェクトのみ表示

### 利点

1. **一覧性**: マップ上の全オブジェクトを一度に確認
2. **効率的な編集**: 2Dマップで探す必要なし
3. **カテゴリ別管理**: 同じ種類のオブジェクトを一括確認
4. **リアルタイムプレビュー**: 変更内容を即座に3Dで確認
5. **独立タブ**: マップビューと並行して作業可能

### ワークフロー例

#### 全ての棚の高さを統一

```
1. オブジェクトカタログタブを開く
2. カテゴリフィルタで「棚」を選択
3. 各棚を順番に選択
4. 詳細編集で高さを「1.8m」に変更
5. 3Dプレビューで確認後、保存
```

#### 未設定オブジェクトの整理

```
1. カテゴリフィルタで「未設定」を選択
2. 各オブジェクトを選択
3. 適切なカテゴリを設定
4. 高さと前面方向を入力
5. 保存して次のオブジェクトへ
```

### 注意事項

- オブジェクトカタログで編集した内容は、2Dマップビューアと3Dマップビューに即座に反映されます
- リサイザーをドラッグすることで、左右パネルの幅を調整できます
- 詳細編集パネルは「✕」ボタンで閉じることができます

---

## 関連ドキュメント

- [OPERATION-CATALOG.md](./OPERATION-CATALOG.md) - 操作カタログ仕様
- [ARCHITECTURE.md](./ARCHITECTURE.md) - システムアーキテクチャ
- [MODULE_INDEX.md](./MODULE_INDEX.md) - モジュール索引
- [AI_GUIDELINES.md](./AI_GUIDELINES.md) - 開発ガイドライン
