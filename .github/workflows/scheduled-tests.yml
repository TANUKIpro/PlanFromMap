name: Scheduled Tests

on:
  schedule:
    # Run tests every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  full-test-suite:
    name: Full Test Suite (Scheduled)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run all tests
      run: |
        pytest tests/ -v --tb=short --maxfail=10
      continue-on-error: true

    - name: Run slow E2E tests
      run: |
        pytest tests/e2e/ -v --tb=short -m "slow"
      timeout-minutes: 60
      continue-on-error: true

    - name: Generate coverage report
      run: |
        pytest tests/ --cov=apps --cov-report=html --cov-report=xml --cov-report=term
      continue-on-error: true

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: scheduled-test-results-${{ github.run_number }}
        path: |
          tests/outputs/
          htmlcov/
          coverage.xml
        retention-days: 30

    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = `Scheduled tests failed on ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## Scheduled Test Failure

          The scheduled test suite run failed.

          **Run ID**: ${{ github.run_id }}
          **Run Number**: ${{ github.run_number }}

          Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          ### Next Steps
          1. Review the test failures
          2. Check if this is a flaky test or a real issue
          3. Fix the issue or update the tests
          4. Close this issue once resolved
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['automated', 'test-failure']
          });

  performance-test:
    name: Performance Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-benchmark

    - name: Run performance tests
      run: |
        # Run E2E tests with timing
        pytest tests/e2e/test_full_workflow.py::TestPerformanceWorkflow -v --durations=10
      continue-on-error: true

    - name: Performance summary
      run: |
        echo "## Performance Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Performance tests completed. Check artifacts for detailed results." >> $GITHUB_STEP_SUMMARY
