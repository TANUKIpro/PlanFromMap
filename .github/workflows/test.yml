name: Test Suite

on:
  push:
    branches: [ main, develop, "claude/**" ]
  pull_request:
    branches: [ main, develop ]

jobs:
  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better coverage reports

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run unit tests (frontend)
      run: |
        pytest tests/unit/frontend/ -v --tb=short --maxfail=5
      continue-on-error: false

    - name: Run unit tests (backend)
      run: |
        pytest tests/unit/backend/ -v --tb=short --maxfail=5
      continue-on-error: true  # Flask may not be needed for all tests

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: unit-test-results-py${{ matrix.python-version }}
        path: |
          tests/outputs/
          .pytest_cache/
        retention-days: 7

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Verify test data exists
      run: |
        ls -la data/maps/
        test -f data/maps/tid_lab_map.yaml || echo "Warning: YAML file not found"
        test -f data/maps/tid_lb_map.pgm || echo "Warning: PGM file not found"

    - name: Run integration tests
      run: |
        pytest tests/integration/ -v --tb=short

    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: integration-test-results
        path: tests/outputs/
        retention-days: 7

  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests with coverage
      run: |
        pytest tests/unit/frontend/ --cov=apps/frontend/static/js --cov-report=xml --cov-report=html --cov-report=term
      continue-on-error: true

    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: |
          htmlcov/
          coverage.xml
        retention-days: 30

    - name: Coverage summary
      if: always()
      run: |
        if [ -f coverage.xml ]; then
          echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coverage report generated successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š See artifacts for detailed HTML report" >> $GITHUB_STEP_SUMMARY
        fi

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run E2E tests
      run: |
        pytest tests/e2e/ -v --tb=short -m "not slow"
      timeout-minutes: 10

    - name: Run slow E2E tests
      if: github.event_name == 'pull_request'
      run: |
        pytest tests/e2e/ -v --tb=short -m "slow"
      timeout-minutes: 30
      continue-on-error: true

    - name: Upload E2E test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: e2e-test-results
        path: |
          tests/outputs/
          tests/outputs/screenshots/
        retention-days: 14

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, coverage]
    if: always()

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      continue-on-error: true

    - name: Create test summary
      run: |
        echo "# ðŸ§ª Test Suite Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.unit-tests.result }}" == "success" ]; then
          echo "âœ… Unit Tests: **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Unit Tests: **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.integration-tests.result }}" == "success" ]; then
          echo "âœ… Integration Tests: **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Integration Tests: **NEEDS REVIEW**" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.coverage.result }}" == "success" ]; then
          echo "âœ… Coverage Report: **GENERATED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Coverage Report: **INCOMPLETE**" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Unit test results (Python 3.8-3.11)" >> $GITHUB_STEP_SUMMARY
        echo "- Integration test results" >> $GITHUB_STEP_SUMMARY
        echo "- Coverage reports (HTML + XML)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check the **Artifacts** section below to download detailed reports." >> $GITHUB_STEP_SUMMARY
