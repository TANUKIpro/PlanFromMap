name: Pull Request Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check PR title
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "PR Title: $PR_TITLE"

        # Check if PR title follows conventional commits
        if echo "$PR_TITLE" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+"; then
          echo "âœ… PR title follows conventional commits format"
        else
          echo "âš ï¸ PR title should follow conventional commits format"
          echo "Examples:"
          echo "  - feat: add new feature"
          echo "  - fix: resolve bug"
          echo "  - docs: update documentation"
          echo "  - test: add tests"
        fi

    - name: Check changed files
      run: |
        echo "## Changed Files" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Check for test files
      run: |
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})

        # Check if any Python files in apps/ were changed
        if echo "$CHANGED_FILES" | grep -q "^apps/.*\.py$"; then
          # Check if corresponding test files were added/modified
          if echo "$CHANGED_FILES" | grep -q "^tests/"; then
            echo "âœ… Test files included in this PR"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Tests Updated**: This PR includes test changes" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No test files found, but Python code was changed"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Tests Missing**: Consider adding tests for the changed code" >> $GITHUB_STEP_SUMMARY
          fi
        fi

  quick-test:
    name: Quick Test (Frontend Unit Tests)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pyyaml

    - name: Run quick tests
      run: |
        pytest tests/unit/frontend/ -v --tb=line --maxfail=3
      timeout-minutes: 2

    - name: Test result summary
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "âœ… **Quick tests passed!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Quick tests failed!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please fix the failing tests before merging." >> $GITHUB_STEP_SUMMARY
        fi

  pr-size-check:
    name: PR Size Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check PR size
      run: |
        # Count lines changed
        ADDITIONS=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | awk '{sum+=$1} END {print sum}')
        DELETIONS=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | awk '{sum+=$2} END {print sum}')
        TOTAL=$((ADDITIONS + DELETIONS))

        echo "## PR Size Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Lines Added**: $ADDITIONS" >> $GITHUB_STEP_SUMMARY
        echo "- **Lines Deleted**: $DELETIONS" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Changes**: $TOTAL" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ $TOTAL -lt 300 ]; then
          echo "ðŸŸ¢ **Size**: Small (easy to review)" >> $GITHUB_STEP_SUMMARY
        elif [ $TOTAL -lt 1000 ]; then
          echo "ðŸŸ¡ **Size**: Medium" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ”´ **Size**: Large (consider splitting into smaller PRs)" >> $GITHUB_STEP_SUMMARY
        fi

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Check Python syntax
      run: |
        python -m py_compile $(find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" -not -path "./build/*")
        echo "âœ… All Python files have valid syntax" >> $GITHUB_STEP_SUMMARY

    - name: Check for common issues
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Code Quality Checks" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Check for print statements in production code (warning only)
        if grep -r "print(" apps/ --include="*.py" | grep -v "# DEBUG"; then
          echo "âš ï¸ Found print() statements in production code" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… No print() statements in production code" >> $GITHUB_STEP_SUMMARY
        fi

        # Check for TODO comments
        TODO_COUNT=$(grep -r "TODO" apps/ tests/ --include="*.py" | wc -l)
        if [ $TODO_COUNT -gt 0 ]; then
          echo "ðŸ“ Found $TODO_COUNT TODO comments" >> $GITHUB_STEP_SUMMARY
        fi

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [pr-validation, quick-test, pr-size-check, code-quality]
    if: always()

    steps:
    - name: Create summary
      run: |
        echo "# ðŸ“‹ Pull Request Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Check Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.pr-validation.result }}" == "success" ]; then
          echo "âœ… PR Validation" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ PR Validation" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.quick-test.result }}" == "success" ]; then
          echo "âœ… Quick Tests" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Quick Tests" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.pr-size-check.result }}" == "success" ]; then
          echo "âœ… PR Size Check" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ PR Size Check" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.code-quality.result }}" == "success" ]; then
          echo "âœ… Code Quality" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Code Quality" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Full test suite will run after PR checks pass." >> $GITHUB_STEP_SUMMARY
